//Vytis Etchegoyhen, David Kaio Tsuchiya, Artour, Tristan

//LCD DISPLAY ====================================================
#include <LiquidCrystal.h>
const int RS = 12, EN = 11, D4 = 5, D5 = 4, D6 = 3, D7 = 2;
LiquidCrystal lcd(RS, EN, D4, D5, D6, D7);

//STEPPER MOTOR ==================================================
#include <Stepper.h>

const int stepsPerRevolution = 200;
Stepper stepper(stepsPerRevolution, 21, 19, 20, 18);


//BUTTONS/LED ====================================================

// Define Port B Register Pointers
volatile unsigned char* port_b = (unsigned char*) 0x25;
volatile unsigned char* ddr_b  = (unsigned char*) 0x24;
volatile unsigned char* pin_b  = (unsigned char*) 0x23;
// Define Port C Register Pointers
volatile unsigned char* port_c = (unsigned char*) 0x28;
volatile unsigned char* ddr_c  = (unsigned char*) 0x27;
volatile unsigned char* pin_c  = (unsigned char*) 0x26;

//WATER SENSOR ===================================================
#define RDA 0x80
#define TBE 0x20  
volatile unsigned char *myUCSR0A = (unsigned char *)0x00C0;
volatile unsigned char *myUCSR0B = (unsigned char *)0x00C1;
volatile unsigned char *myUCSR0C = (unsigned char *)0x00C2;
volatile unsigned int  *myUBRR0  = (unsigned int *) 0x00C4;
volatile unsigned char *myUDR0   = (unsigned char *)0x00C6;
 
volatile unsigned char* my_ADMUX = (unsigned char*) 0x7C;
volatile unsigned char* my_ADCSRB = (unsigned char*) 0x7B;
volatile unsigned char* my_ADCSRA = (unsigned char*) 0x7A;
volatile unsigned int* my_ADC_DATA = (unsigned int*) 0x78;
#define threshold_display 500

//TEMP/HUMIDITY SENSOR ===========================================
#include <DHT.h>
#define DHTPIN 6 //whatever pin we have humidifier connected to
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);

//FAN ============================================================
volatile unsigned char* port_a = (unsigned char*) 0x22;
volatile unsigned char* ddr_a  = (unsigned char*) 0x21;
volatile unsigned char* pin_a  = (unsigned char*) 0x20;

int state = 1;

//================================================================

void setup() 
{
   // // setup the UART
  // U0init(9600);
  // // setup the ADC
  // adc_init();

  dht.begin();

  lcd.begin(16, 2);   // Initialize the LCD (if you're using one)
  lcd.setCursor(0, 0);  // Set cursor to the first row

  stepper.setSpeed(100);

  Serial.begin(9600);

  //set PC(0-1, 5-7) to INPUT
  *ddr_c &= B00000000;
  // enable the pullup resistor on PC(0-1, 5-7)
  *port_c |= B11100011;

  //set PB(0-3) to OUTPUT
  *ddr_b = B00001111;
  //set A0 to OUTPUT
  *ddr_a = B00000001;
}

//===============================================================

void loop() 
{
  //int state = 1;  //(1)Disabled, (2)Idle, (3)Running, (4)Error
  //State Logic
  if(state == 1){ //Disabled
    //TURN Yellow on
    *port_b |= B00001000;
    *port_b &= B00001000;
    //Fan off
    *port_b &= B00000000;
    //Monitor Start Button
    if(!(*pin_c & (1 << PC7))){
      state = 2;
    }
  }
  else if(state == 2){ //Idle
    //TURN Green on
    *port_b |= B00000100;
    *port_b &= B00000100;
    *port_b |= B00000010;
    //Check temp
    //if temp > threshold then fan on
    //*port_b |= B00000010;
    //state == 3

    //Check water level (change to Error if low)**

  }
  else if(state == 3){ //Running
    //TURN Blue on
    *port_b |= B00000010;
    *port_b &= B00000010;

    //Monitor Water Level
    //Monitor Temp <= threshold
  }
  else if(state == 4){ //Error
    //TURN Red on
    *port_b |= B00000001;
    *port_b &= B00000001;

    //TURN FAN OFF
    //ERROR ON LCD SCREEN** 

    //Monitor Reset Button & Water Level
    if(!(*pin_c & (1 << PC5))){ //only reset button rn
      state = 4;
    }
  }

  //All States Except Disabled
  if(state == 2 || state == 3 || state == 4){
    //Monitor Stop Button (go to disabled state)
    if(!(*pin_c & (1 << PC6))){
      state = 1;
    }

    //Monitor Water (per min)
    //Monitor Humidity and Temp (per min)
    float humid = dht.readHumidity(); // Reads humidity
    float temp = dht.readTemperature(); //Reads Temperature

    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Humidity: ");
    lcd.print(humid);
    lcd.print("%");
    lcd.setCursor(0, 1);
    lcd.print("Temp: ");
    lcd.print(temp);
    lcd.print("C");

    //Ventilation Changes (Stepper Motor)
    if(!(*pin_c & (1 << PC1))){ //Left Button
      stepper.step(25);
      *port_b |= B00000100;
      *port_b &= B00000100;
    }else if(!(*pin_c & (1 << PC0))){ //Right Button
      stepper.step(-25);
      *port_b |= B00000010;
      *port_b &= B00000010;
    }
  }
}
